package com.aerospike.connect

import io.snyk.gradle.plugin.SnykExtension
import org.gradle.api.Project
import org.gradle.api.tasks.Exec
import org.gradle.kotlin.dsl.configure
import org.gradle.kotlin.dsl.provideDelegate

/**
 * Setup Snyk vulnerability scanning.
 */
fun Project.setupVulnerabilityScanning() {
    val snykTokens: String by project
    val snykToken = snykTokens.split(",").map { it.trim() }.random()

    tasks.register("setup-snyk", Exec::class.java) {
        commandLine("${project.rootDir}/snyk", "auth", snykToken)
    }
    tasks.getByName("snyk-check-binary").finalizedBy("setup-snyk")

    /**
     * Vulnerability scanning with Snyk.
     */
    configure<SnykExtension> {
        setApi(snykToken)
        setSeverity("high")
        setAutoDownload(true)
        setArguments("--sub-project=" + project.name)
    }
}
